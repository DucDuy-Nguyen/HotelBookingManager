@model IEnumerable<HotelBookingManager.DataAccess.Models.Booking>

@{
    ViewData["Title"] = "Quản lý booking";
    var currentStatus = (ViewBag.Status as string) ?? "Pending";
}

<h2>Quản lý booking</h2>

<a asp-action="Create" class="btn btn-success mb-3">Tạo booking</a>

<form asp-action="Index" method="get" class="mb-3">
    <label class="form-label me-2">Trạng thái</label>
    <select name="status"
            class="form-select d-inline-block w-auto"
            onchange="this.form.submit()">
        <option value="Pending" selected="@(currentStatus == "Pending")">Pending</option>
        <option value="Confirmed" selected="@(currentStatus == "Confirmed")">Confirmed</option>
        <option value="CheckedIn" selected="@(currentStatus == "CheckedIn")">Checked In</option>
        <option value="Completed" selected="@(currentStatus == "Completed")">Checked Out</option>
        <option value="Cancelled" selected="@(currentStatus == "Cancelled")">Cancelled</option>
        <option value="All" selected="@(currentStatus == "All")">Tất cả</option>
    </select>
</form>

<table class="table table-bordered table-striped">
    <thead class="table-light">
        <tr>
            <th>Booking #</th>
            <th>Khách</th>
            <th>Khách sạn</th>
            <th>Phòng</th>
            <th>Check-in</th>
            <th>Check-out</th>
            <th>Tổng tiền</th>
            <th>Trạng thái</th>
            <th>Thanh toán</th>
            <th>Thao tác</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var b in Model)
        {
            <tr>
                <td>@b.BookingId</td>
                <td>@b.User?.FullName</td>
                <td>@b.Hotel?.Name</td>
                <td>@b.Room?.RoomNumber</td>
                <td>@b.CheckInDate.ToString("dd/MM/yyyy")</td>
                <td>@b.CheckOutDate.ToString("dd/MM/yyyy")</td>
                <td>@b.TotalPrice.ToString("N0")</td>
                <td>@b.Status</td>

                @* CỘT TRẠNG THÁI THANH TOÁN *@
                <td>
                    @{
                        var payment = b.Payments?
                        .OrderByDescending(p => p.CreatedAt)
                        .FirstOrDefault();

                        var isPaid = payment?.Status == "Success";
                        var isCashPending = payment?.Method == "Cash" && payment?.Status == "Pending";

                    }


                    @if (isPaid)
                    {
                        <span class="badge bg-success">Đã thanh toán</span>
                    }
                    else if (isCashPending)
                    {
                        <span class="badge bg-warning text-dark">Chờ thu tiền mặt</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">Chưa thanh toán</span>
                    }

                </td>


                @* CỘT THAO TÁC *@
                <td>
                    <div class="btn-group" role="group">

                        @* Thanh toán *@
                        @if (b.Status == "Confirmed" && payment == null)
                        {
                            <a asp-controller="Payments"
                               asp-action="Pay"
                               asp-route-bookingId="@b.BookingId"
                               class="btn btn-sm btn-primary">
                                Thanh toán
                            </a>
                        }

                        @* @if (b.Status != "Paid" && b.Status != "Cancelled" && !isPaid)
                        {
                            <a asp-controller="Payments"
                               asp-action="Pay"
                               asp-route-bookingId="@b.BookingId"
                               class="btn btn-sm btn-primary">
                                Thanh toán
                            </a>
                        } *@





                        @* Check-in *@
                        @if (b.Status == "Confirmed" && isPaid)
                        {
                            <form asp-action="ChangeStatus" method="post" class="d-inline">
                                <input type="hidden" name="id" value="@b.BookingId" />
                                <input type="hidden" name="newStatus" value="CheckedIn" />
                                <button class="btn btn-sm btn-success">Check-in</button>
                            </form>
                        }
                        @* Check-out *@
                        @if (b.Status == "CheckedIn")
                        {
                            <form asp-action="ChangeStatus" method="post" class="d-inline">
                                <input type="hidden" name="id" value="@b.BookingId" />
                                <input type="hidden" name="newStatus" value="Completed" />
                                <button type="submit" class="btn btn-sm btn-warning">
                                    Check-out
                                </button>
                            </form>
                        }



                        @* Cancel *@
                        @if (b.Status == "Pending" || b.Status == "Confirmed")
                        {
                            <form asp-action="ChangeStatus" method="post" class="d-inline">
                                <input type="hidden" name="id" value="@b.BookingId" />
                                <input type="hidden" name="newStatus" value="Cancelled" />
                                <button type="submit" class="btn btn-sm btn-danger">Cancel</button>
                            </form>
                        }
                    </div>
                </td>

            </tr>
        }
    </tbody>
</table>
