@model HotelBookingManager.BusinessObjects.DTO.RoomDto

<h2>Sửa phòng</h2>

<form asp-action="Edit" method="post" id="editRoomForm">
    <input type="hidden" asp-for="RoomId" />
    <div asp-validation-summary="All" class="text-danger"></div>

    <!-- ✨ Thêm div để hiển thị error custom -->
    <div id="customError" class="alert alert-danger" style="display:none;"></div>

    <div class="mb-3">
        <label class="form-label">Khách sạn</label>
        <select asp-for="HotelId"
                class="form-select"
                id="hotelSelect"
                asp-items="ViewBag.HotelId"
                required></select>
        <span asp-validation-for="HotelId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Loại phòng</label>
        <select asp-for="RoomTypeId"
                class="form-select"
                asp-items="ViewBag.RoomTypeId"
                required></select>
        <span asp-validation-for="RoomTypeId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Số phòng</label>
        <input asp-for="RoomNumber"
               class="form-control"
               id="roomNumber"
               required />
        <small class="text-danger" id="roomNumberError"></small>
        <span asp-validation-for="RoomNumber" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Tầng</label>
        <input asp-for="Floor"
               class="form-control"
               type="number" />
        <span asp-validation-for="Floor" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Giá hiện tại</label>
        <input asp-for="CurrentPrice"
               class="form-control"
               type="number"
               step="0.01"
               required />
        <span asp-validation-for="CurrentPrice" class="text-danger"></span>
    </div>

    <!-- ✨ THÊM: Dropdown Status -->
    <div class="mb-3">
        <label class="form-label">Trạng thái</label>
        <select asp-for="Status" class="form-select" required>
            <option value="Available">Có Sẵn (Available)</option>
            <option value="Booked">Đã Đặt (Booked)</option>
        </select>
        <span asp-validation-for="Status" class="text-danger"></span>
    </div>

    <div class="form-check mb-3">
        <input asp-for="IsActive" class="form-check-input" />
        <label asp-for="IsActive" class="form-check-label"></label>
    </div>

    <button type="submit" class="btn btn-primary" id="submitBtn">Lưu</button>
    <a asp-action="Index" class="btn btn-secondary">Quay lại</a>
</form>

<!-- ✨ Script validation -->
<script>
    // Dữ liệu phòng từ server (dùng ViewBag)
    const allRoomsByHotel = @Html.Raw(ViewBag.AllRoomsByHotel ?? "{}");
    const currentRoomId = @Model.RoomId;

    // Lấy form element
    const form = document.getElementById('editRoomForm');
    const hotelSelect = document.getElementById('hotelSelect');
    const roomNumberInput = document.getElementById('roomNumber');
    const roomNumberError = document.getElementById('roomNumberError');
    const customError = document.getElementById('customError');
    const submitBtn = document.getElementById('submitBtn');

    // ✨ Check phòng trùng khi thay đổi hotel hoặc số phòng
    function validateRoomNumber() {
        const hotelId = hotelSelect.value;
        const roomNumber = roomNumberInput.value.trim();

        // Clear error
        roomNumberError.textContent = '';
        customError.style.display = 'none';

        if (!hotelId || !roomNumber) {
            submitBtn.disabled = false;
            return true;
        }

        // Lấy danh sách phòng của hotel này
        const roomsInHotel = allRoomsByHotel[hotelId] || [];

        // Kiểm tra xem có phòng trùng không (bỏ qua phòng hiện tại)
        const isDuplicate = roomsInHotel.some(r =>
            r.RoomNumber === roomNumber && r.RoomId !== currentRoomId
        );

        if (isDuplicate) {
            roomNumberError.textContent = `❌ Phòng số ${roomNumber} đã tồn tại!`;
            customError.textContent = `Phòng số ${roomNumber} đã tồn tại ở khách sạn này. Vui lòng chọn số phòng khác.`;
            customError.style.display = 'block';
            submitBtn.disabled = true;
            return false;
        }

        submitBtn.disabled = false;
        return true;
    }

    // ✨ Lắng nghe sự kiện thay đổi
    hotelSelect.addEventListener('change', validateRoomNumber);
    roomNumberInput.addEventListener('change', validateRoomNumber);
    roomNumberInput.addEventListener('keyup', validateRoomNumber);

    // ✨ Validate trước khi submit
    form.addEventListener('submit', function(e) {
        if (!validateRoomNumber()) {
            e.preventDefault();
            return false;
        }
    });
</script>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
