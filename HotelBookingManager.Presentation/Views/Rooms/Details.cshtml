@model HotelBookingManager.BusinessObjects.DTO.RoomDto

@{
    // Check RoleId từ Session (Cách 1 - ĐƠN GIẢN NHẤT)
    int? userRoleId = Context.Session.GetInt32("RoleId");
    bool isAdminOrStaff = userRoleId.HasValue && (userRoleId == 1 || userRoleId == 2);

    // Fallback: Check từ Claims (Cách 2 - Safe)
    if (!isAdminOrStaff && User.Identity.IsAuthenticated)
    {
        foreach (var claim in User.Claims)
        {
            if ((claim.Type.Contains("role") || claim.Type.Contains("Role")) &&
                int.TryParse(claim.Value, out int parsedRoleId))
            {
                if (parsedRoleId == 1 || parsedRoleId == 2)
                {
                    isAdminOrStaff = true;
                    break;
                }
            }
        }
    }

    // Tính toán main image URL ở đây để tránh lỗi Razor syntax
    string mainImageUrl = "/images/no-image-room.jpg";
    if (Model.RoomImages != null && Model.RoomImages.Any())
    {
        var thumb = Model.RoomImages.FirstOrDefault(i => i.IsThumbnail) ?? Model.RoomImages.First();
        mainImageUrl = thumb.ImageUrl;
    }
}

<div class="row g-4">
    <!-- Left Column - Main Info + Gallery -->
    <div class="col-lg-8">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-primary text-white py-4 rounded-top">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="h4 mb-1 fw-bold">
                            🛏️ Phòng <span class="text-warning">@Model.RoomNumber</span>
                        </h1>
                        <p class="mb-0">
                            <i class="fas fa-building me-2"></i>@Model.HotelName
                            @if (Model.Floor.HasValue)
                            {
                                <span class="badge bg-light text-dark ms-2">Tầng @Model.Floor</span>
                            }
                        </p>
                    </div>
                    <span class="badge fs-6 px-3 py-2 @(Model.IsActive ? "bg-success" : "bg-danger")">
                        @(Model.IsActive ? "🟢 Hoạt động" : "🔴 Ngừng")
                    </span>
                </div>
            </div>

            <div class="card-body p-0">
                <!-- 🖼️ IMAGE GALLERY -->
                @if (Model.RoomImages == null || !Model.RoomImages.Any())
                {
                    <div class="bg-light d-flex align-items-center justify-content-center" style="height: 350px;">
                        <div class="text-center p-4">
                            <i class="fas fa-image fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">Chưa có hình ảnh phòng</h6>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Main Image -->
                    <div class="position-relative" style="height: 350px;">
                        <img src="@mainImageUrl"
                             class="img-fluid w-100 h-100"
                             style="object-fit: cover;"
                             alt="Phòng @Model.RoomNumber"
                             onerror="this.src='/images/no-image-room.jpg'"
                             id="mainRoomImage" />

                        @if (Model.RoomImages.Count > 1)
                        {
                            <div class="position-absolute top-50 start-0 end-0 d-flex justify-content-between px-3">
                                <button class="btn btn-dark btn-sm rounded-circle p-2 shadow"
                                        onclick="prevImage()">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="btn btn-dark btn-sm rounded-circle p-2 shadow"
                                        onclick="nextImage()">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        }
                    </div>

                    <!-- Thumbnail Gallery -->
                    @if (Model.RoomImages.Count > 1)
                    {
                        <div class="p-3 bg-light">
                            <div class="d-flex gap-2 overflow-auto pb-2" style="scrollbar-width: thin;">
                                @foreach (var img in Model.RoomImages)
                                {
                                    <div class="flex-shrink-0">
                                        <img src="@img.ImageUrl"
                                             class="rounded shadow-sm cursor-pointer img-thumbnail-mini"
                                             style="width: 70px; height: 55px; object-fit: cover;"
                                             alt="Thumbnail"
                                             onclick="changeMainImage('@img.ImageUrl')"
                                             onerror="this.src='/images/no-image-room.jpg'" />
                                        @if (img.IsThumbnail)
                                        {
                                            <div class="text-center mt-1">
                                                <span class="badge bg-primary">⭐</span>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }

                <!-- Room Info -->
                <div class="p-4 border-top">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary mb-3">
                                <i class="fas fa-info-circle me-1"></i>Thông tin
                            </h6>
                            <div class="row g-2">
                                <div class="col-12">
                                    <div class="d-flex align-items-center p-3 bg-light rounded shadow-sm">
                                        <i class="fas fa-bed text-warning fs-5 me-3"></i>
                                        <div>
                                            <strong>Loại phòng</strong>
                                            <div class="text-muted small">@Model.RoomTypeName</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-center p-3 bg-light rounded shadow-sm">
                                        <i class="fas fa-layer-group text-info fs-5 me-3"></i>
                                        <div>
                                            <strong>Tầng</strong>
                                            <div class="text-muted small">@(Model.Floor?.ToString() ?? "Chưa xác định")</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6 class="fw-bold text-success mb-3">
                                <i class="fas fa-dollar-sign me-1"></i>Giá phòng
                            </h6>
                            <div class="text-center p-4 bg-success bg-opacity-10 border border-success rounded shadow mb-3">
                                <div class="h3 fw-bold text-success mb-1">@Model.CurrentPrice.ToString("N0")</div>
                                <div class="text-success fw-semibold">VNĐ / đêm</div>
                            </div>
                            <div class="text-center">
                                <span class="badge bg-success-subtle border border-success fs-6 px-3 py-2">
                                    Giá chuẩn
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4 g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded shadow-sm">
                                <i class="fas fa-calendar-check text-info fs-5 me-3"></i>
                                <div>
                                    <strong>Trạng thái</strong>
                                    <div>
                                        @if (Model.Status == "Available")
                                        {
                                            <span class="badge bg-success fs-6">
                                                <i class="fas fa-check-circle me-1"></i>Còn trống
                                            </span>
                                        }
                                        else if (Model.Status == "Booked")
                                        {
                                            <span class="badge bg-danger fs-6">
                                                <i class="fas fa-bed me-1"></i>Hết Phòng
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark fs-6">
                                                @Model.Status
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>

    <!-- Right Column - Actions -->
    <div class="col-lg-4">
        <div class="card h-100 shadow-sm border-0 sticky-top" style="top: 20px;">
            <div class="card-header bg-light border-0 py-3">
                <h6 class="fw-bold text-center mb-0">
                    <i class="fas fa-cogs me-2"></i>Thao tác nhanh
                </h6>
            </div>
            <div class="card-body p-4 text-center">
                @if (Model.Status == "Available")
                {
                    <div class="mb-4">
                        <a asp-controller="Bookings" asp-action="Create"
                           asp-route-roomId="@Model.RoomId" asp-route-hotelId="@Model.HotelId"
                           class="btn btn-success btn-lg w-100 fw-bold py-3 mb-3 shadow-lg rounded-pill fs-6">
                            <i class="fas fa-calendar-check me-2"></i>
                            🏨 Đặt phòng ngay
                        </a>
                    </div>
                }
                else
                {
                    <div class="p-4 bg-warning bg-opacity-10 border-warning border rounded-3 mb-4 text-center">
                        <i class="fas fa-clock text-warning fs-2 d-block mb-2"></i>
                        <h6 class="text-warning fw-bold mb-1">Phòng đã được đặt</h6>
                        <small class="text-muted">Chọn phòng khác</small>
                    </div>
                }

                <div class="d-grid gap-2">
                    @if (isAdminOrStaff)
                    {
                        <a asp-controller="Rooms" asp-action="Edit" asp-route-id="@Model.RoomId"
                           class="btn btn-warning shadow-sm rounded-pill fw-semibold py-3">
                            <i class="fas fa-edit me-2"></i>⚙️ Sửa phòng
                        </a>
                    }
                    <a asp-controller="Hotels" asp-action="Details" asp-route-id="@Model.HotelId"
                       class="btn btn-outline-primary shadow-sm rounded-pill fw-semibold py-3 @(isAdminOrStaff ? "" : "mt-2")">
                        <i class="fas fa-building me-2"></i>Khách sạn
                    </a>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentImageIndex = 0;
    const images = @Html.Raw(Json.Serialize(Model.RoomImages?.Select(i => i.ImageUrl) ?? new List<string>()));

    function changeMainImage(url) {
        document.getElementById('mainRoomImage').src = url;
    }

    function prevImage() {
        if (images && images.length > 0) {
            currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
            changeMainImage(images[currentImageIndex]);
        }
    }

    function nextImage() {
        if (images && images.length > 0) {
            currentImageIndex = (currentImageIndex + 1) % images.length;
            changeMainImage(images[currentImageIndex]);
        }
    }
</script>

<style>
    .card {
        border-radius: 16px;
        transition: all 0.3s ease;
    }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15) !important;
        }

    .btn {
        transition: all 0.3s ease;
        border-radius: 12px;
    }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

    .img-thumbnail-mini {
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .img-thumbnail-mini:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 2px solid #007bff;
        }

    .cursor-pointer {
        cursor: pointer;
    }

    .sticky-top {
        top: 20px;
    }

    @@media (max-width: 768px) {
        [style*="height: 350px"] {
            height: 250px !important;
        }

        .img-thumbnail-mini {
            width: 60px !important;
            height: 48px !important;
        }
    }
</style>
